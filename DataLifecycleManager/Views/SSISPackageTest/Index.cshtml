@{
    ViewData["Title"] = "SSIS Package Execution";
}

<div class="container mt-4">
    <div class="row">
        <div class="col-md-12">
            <h2><i class="fas fa-cube me-2"></i>SSIS Package Execution</h2>
            <p class="text-muted">Execute SSIS packages from SSISDB Catalog</p>
            <hr />
        </div>
    </div>

    <div class="row">
        <div class="col-md-8 mx-auto">
            <div class="card shadow">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0"><i class="fas fa-database me-2"></i>SSIS Catalog Execution</h5>
                </div>
                <div class="card-body">
                    <p class="text-muted">Execute SSIS package from SSISDB Catalog with parameters</p>

                    <h6 class="text-primary mb-3"><i class="fas fa-folder me-2"></i>Catalog Location</h6>

                    <div class="mb-3">
                        <label for="folderName" class="form-label">Folder Name <span
                                class="text-danger">*</span></label>
                        <input type="text" id="folderName" class="form-control" value="DataLifecycleManager"
                            placeholder="Enter folder name" required>
                    </div>

                    <div class="mb-3">
                        <label for="projectName" class="form-label">Project Name <span
                                class="text-danger">*</span></label>
                        <input type="text" id="projectName" class="form-control" value="HospitalArchival"
                            placeholder="Enter project name" required>
                    </div>

                    <div class="mb-3">
                        <label for="packageName" class="form-label">Package Name <span
                                class="text-danger">*</span></label>
                        <input type="text" id="packageName" class="form-control" value="ArchivePatientRecords.dtsx"
                            placeholder="Enter package name (e.g., Package.dtsx)" required>
                    </div>

                    <hr class="my-4">

                    <h6 class="text-primary mb-3"><i class="fas fa-database me-2"></i>Source Connection Parameters</h6>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="srcServer" class="form-label">Source Server <span
                                    class="text-danger">*</span></label>
                            <input type="text" id="srcServer" class="form-control" placeholder="e.g., localhost"
                                required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="srcDatabase" class="form-label">Source Database <span
                                    class="text-danger">*</span></label>
                            <input type="text" id="srcDatabase" class="form-control" placeholder="e.g., HospitalDB"
                                required>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="srcUser" class="form-label">Source User</label>
                            <input type="text" id="srcUser" class="form-control"
                                placeholder="Optional (leave empty for Windows Auth)">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="srcPassword" class="form-label">Source Password</label>
                            <input type="password" id="srcPassword" class="form-control" placeholder="Optional">
                        </div>
                    </div>

                    <hr class="my-4">

                    <h6 class="text-primary mb-3"><i class="fas fa-database me-2"></i>Destination Connection Parameters
                    </h6>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="destServer" class="form-label">Destination Server <span
                                    class="text-danger">*</span></label>
                            <input type="text" id="destServer" class="form-control" placeholder="e.g., localhost"
                                required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="destDatabase" class="form-label">Destination Database <span
                                    class="text-danger">*</span></label>
                            <input type="text" id="destDatabase" class="form-control"
                                placeholder="e.g., HospitalArchiveDB" required>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="destUser" class="form-label">Destination User</label>
                            <input type="text" id="destUser" class="form-control"
                                placeholder="Optional (leave empty for Windows Auth)">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="destPassword" class="form-label">Destination Password</label>
                            <input type="password" id="destPassword" class="form-control" placeholder="Optional">
                        </div>
                    </div>

                    <div class="d-grid">
                        <button id="btnCatalogRun" class="btn btn-success btn-lg">
                            <i class="fas fa-play me-2"></i>Execute Package
                        </button>
                    </div>

                    <div id="catalogResults" class="mt-4"></div>
                </div>
            </div>
        </div>
    </div>

    <div class="row mt-4">
        <div class="col-md-8 mx-auto">
            <div class="card shadow-sm">
                <div class="card-header bg-info text-white">
                    <h6 class="mb-0"><i class="fas fa-info-circle me-2"></i>Catalog Path Structure</h6>
                </div>
                <div class="card-body">
                    <p class="mb-2"><strong>SSISDB Hierarchy:</strong></p>
                    <code>
                        SSISDB → [Folder Name] → [Project Name] → [Package Name]
                    </code>
                    <hr>
                    <p class="mb-1 small text-muted">
                        <strong>Example:</strong> SSISDB → DataLifecycleManager → HospitalArchival →
                        ArchivePatientRecords.dtsx
                    </p>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        $(document).ready(function () {
            // SSIS Catalog execution
            $('#btnCatalogRun').click(function () {
                var $btn = $(this);
                var $results = $('#catalogResults');
                var folderName = $('#folderName').val();
                var projectName = $('#projectName').val();
                var packageName = $('#packageName').val();

                // Get parameter values
                var srcServer = $('#srcServer').val();
                var srcDatabase = $('#srcDatabase').val();
                var srcUser = $('#srcUser').val();
                var srcPassword = $('#srcPassword').val();
                var destServer = $('#destServer').val();
                var destDatabase = $('#destDatabase').val();
                var destUser = $('#destUser').val();
                var destPassword = $('#destPassword').val();

                if (!folderName || !projectName || !packageName) {
                    $results.html('<div class="alert alert-warning"><i class="fas fa-exclamation-triangle me-2"></i>Please fill in folder, project, and package name</div>');
                    return;
                }

                if (!srcServer || !srcDatabase || !destServer || !destDatabase) {
                    $results.html('<div class="alert alert-warning"><i class="fas fa-exclamation-triangle me-2"></i>Please fill in required source and destination connection parameters</div>');
                    return;
                }

                $btn.prop('disabled', true).html('<i class="fas fa-spinner fa-spin me-2"></i>Executing...');
                $results.html('<div class="alert alert-info"><i class="fas fa-spinner fa-spin me-2"></i>Executing SSIS package from catalog...</div>');

                $.ajax({
                    url: '@Url.Action("RunFromCatalog", "SSISPackage")',
                    type: 'POST',
                    data: {
                        folderName: folderName,
                        projectName: projectName,
                        packageName: packageName,
                        srcServer: srcServer,
                        srcDatabase: srcDatabase,
                        srcUser: srcUser,
                        srcPassword: srcPassword,
                        destServer: destServer,
                        destDatabase: destDatabase,
                        destUser: destUser,
                        destPassword: destPassword
                    },
                    success: function (response) {
                        if (response.success) {
                            var html = '<div class="alert alert-success">' +
                                '<h6><i class="fas fa-check-circle me-2"></i>Execution Succeeded</h6>' +
                                '<hr>' +
                                '<p><strong>Execution ID:</strong> ' + response.executionId + '</p>' +
                                '<p><strong>Status:</strong> <span class="badge bg-success">' + response.status + '</span></p>' +
                                '<p><strong>Duration:</strong> ' + response.durationSeconds + ' seconds</p>' +
                                '<p><strong>Catalog Path:</strong> ' + folderName + '/' + projectName + '/' + packageName + '</p>' +
                                '<details class="mt-2">' +
                                '<summary><strong>Execution Logs</strong></summary>' +
                                '<pre class="mt-2 bg-light p-2" style="font-size: 0.85rem; max-height: 400px; overflow-y: auto;">' + response.logs + '</pre>' +
                                '</details>' +
                                '</div>';
                            $results.html(html);
                        } else {
                            var html = '<div class="alert alert-danger">' +
                                '<h6><i class="fas fa-exclamation-triangle me-2"></i>Execution Failed</h6>' +
                                '<hr>' +
                                '<p><strong>Error:</strong> ' + (response.errorMessage || 'Unknown error') + '</p>' +
                                '<details class="mt-2">' +
                                '<summary><strong>Logs</strong></summary>' +
                                '<pre class="mt-2 bg-light p-2" style="font-size: 0.85rem;">' + response.logs + '</pre>' +
                                '</details>' +
                                '</div>';
                            $results.html(html);
                        }
                    },
                    error: function (xhr, status, error) {
                        $results.html('<div class="alert alert-danger">' +
                            '<i class="fas fa-exclamation-triangle me-2"></i>Error: ' + error +
                            '</div>');
                    },
                    complete: function () {
                        $btn.prop('disabled', false).html('<i class="fas fa-play me-2"></i>Execute Package');
                    }
                });
            });
        });
    </script>
}